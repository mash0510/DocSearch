@model DocSearch.Models.SetupModel

@{
    ViewBag.Title = "Setup";
}

<h2 style="margin-bottom: 20px">設定画面</h2>

<!-- クロール先フォルダの指定 -->
<div class="ds-container">
    <h4>クロール先のフォルダの指定</h4>
    @using (Html.BeginForm("SetupCrawlFolder", "Setup", FormMethod.Post))
    {
        <div class="form-group">
            <label class="control-label">クロール先のフォルダを指定して下さい。改行で複数のフォルダを指定出来ます。</label>
            @Html.TextAreaFor(m => m.CrawlFolders, new { @class = "form-control", rows = "5", id="crawlFoldersTextBox" })
        </div>
        <button type="submit" id="folderApplyButton" class="btn btn-default right">適用</button>
    }
</div>

<!-- クロール開始 -->
<div class="ds-container">
    <h4>クロール処理の開始</h4>
    @using (Html.BeginForm("StartCrawl", "Setup", FormMethod.Post))
    {
        <div class="form-group">
            <div class="row">
                <div class="col-md-3">
                    <label class="control-label">クロール後の関連語学習</label>
                </div>
                <div class="col-md-2">
                   @Html.DropDownListFor(m => m.ExecMachineLearning,
                     new SelectListItem[] {
                        new SelectListItem() { Value="0", Text="しない" },
                        new SelectListItem() { Value="1", Text="する" }
                     },
                     new { @class="form-control", id="execMachineLearningOption" })
                </div>
                <div class="col-md-1 text-center">
                    <button type="button" id="crawlStartButton" class="btn btn-default" onclick="StartCrawl()">開始</button>
                </div>
                <div class="col-md-1 text-center">
                    <button type="button" id="crawlCancelButton" class="btn btn-default" onclick="CancelCrawl()">キャンセル</button>
                </div>
                <div class="col-md-1 text-center">
                    <button type="button" id="crawlHistoryButton" class="btn btn-default" onclick="GetHistoryData('Crawl')">履歴</button>
                </div>
            </div>
            <br />
            <div class="row">
                <div id="crawlProgressBar">
                    <div class="col-md-7">
                        <div class="progress progress-striped active" id="progressType">
                            <div class="progress-bar" id="progressBar" role="progressbar" style="width: 0%;">
                            </div>
                        </div>
                    </div>
                    <div class="col-md-5">
                        <label class="progress-rate" id="progressRate"></label>
                    </div>
                </div>
            </div>
       </div>
    }
</div>

<div class="ds-container">
    <h4>関連語学習の開始</h4>
    @using (Html.BeginForm("StartMachineLearning", "Setup", FormMethod.Post))
    {
        <div class="form-group">
            <div class="row">
                <div class="col-md-5">
                    <label class="control-label">関連語を表示する人工知能の学習の実行</label>
                </div>
                <div class="col-md-1 text-center">
                    <button type="button" id="machineLearningStartButton" class="btn btn-default" onclick="StartMachineLearning()">開始</button>
                </div>
                <div class="col-md-1 text-center">
                    <button type="button" id="machineLearningCancelButton" class="btn btn-default" onclick="CancelMachineLearning()">キャンセル</button>
                </div>
                <div class="col-md-1 text-center">
                    <button type="button" id="crawlHistoryButton" class="btn btn-default" onclick="GetHistoryData('word2vec')">履歴</button>
                </div>
            </div>
            <br />
            <div class="row">
                <div id="machineLearningProgressBar">
                    <div class="col-md-7">
                        <div class="progress progress-striped active" id="progressType">
                            <div class="progress-bar" id="progressBar" role="progressbar" style="width: 0%;">
                            </div>
                        </div>
                    </div>
                    <div class="col-md-5">
                        <label class="progress-rate" id="progressRate"></label>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<!-- スケジューリング設定 -->
<div class="container">
    <h4>スケジュール設定</h4>
    <div id="onetime">
        <div class="row">
            <div class="col-md-1">
                <select id="schedule-select" onchange="ScheduleTypeChanged(this)">
                    <option value="oneTime" selected>1回のみ</option>
                    <option value="date">日毎</option>
                    <option value="day">曜日</option>
                    <option value="detail">詳細設定</option>
                </select>
            </div>
            <div class="col-md-11">
                <div id="schedule-oneTime">
                    <input type="datetime-local" id="schedule-oneTime-input" />
                </div>
                <div id="schedule-daily">
                    <div class="row">
                        <div class="col-xs-3">
                            <input type="text" id="schedule-daily-interval" /><lable class="ds-label">日毎</lable>
                        </div>
                        <div class="col-xs-9">
                            <label class="ds-label">実行時間</label><input type="time" id="schedule-daily-time"/>
                        </div>
                    </div>
                </div>
                <div id="schedule-day">
                        <input type="checkbox" value="mon" name="schedule-day-mon" />月
                        <input type="checkbox" value="tue" name="schedule-day-tue" style="margin-left: 10px" />火
                        <input type="checkbox" value="wed" name="schedule-day-wed" style="margin-left: 10px" />水
                        <input type="checkbox" value="thr" name="schedule-day-thr" style="margin-left: 10px" />木
                        <input type="checkbox" value="fri" name="schedule-day-fri" style="margin-left: 10px" />金
                        <input type="checkbox" value="sat" name="schedule-day-sat" style="margin-left: 10px" />土
                        <input type="checkbox" value="sun" name="schedule-day-sun" style="margin-left: 10px" />日
                        <label class="ds-label">実行時間</label><input type="time" id="schedule-day-time" />
                </div>
                <div id="schedule-detail">
                        <label class="ds-label">crontab形式で指定して下さい。</label>
                        <input type="text" id="schedule-cron" style="width:300px" />
                </div>
            </div>
        </div>
        <br />
        <div class="row">
            <div class="col-md-1">
                <button type="button" id="setSchedule" class="btn btn-default" onclick="SaveScheduling()">設定</button>
            </div>
            <div class="col-md-1">
                <button type="button" id="revertSchedule" class="btn btn-default">元に戻す</button>
            </div>
            <div class="col-md-1">
                <button type="button" id="clearSchedule" class="btn btn-default">クリア</button>
            </div>
        </div>
    </div>
</div>

<!-- 履歴テーブル -->
<div id="history-form">
    <div class="container">
        <table class="table" id="history">
            <thead id="historyHeader"></thead>
            <tbody id="historyData"></tbody>
        </table>
    </div>
</div>

<!-- 応答メッセージ -->
@{
    if (Model.ProcessFinished)
    {
        <script type="text/javascript">
            alert('@Model.Message');
        </script>
    }
}

<script type="text/javascript">
    var comNotifier;
    var dialog;

    window.onload = function () {
        DisableControls(false);

        comNotifier = $.connection.comHub;

        // サーバー側からのメッセージを受信する部分
        comNotifier.client.sendMessage = function (type, message, args) {
            if (type == "PROGRESS_BAR") {
                var rate = parseInt(args[0]);
                var id = args[1];

                UpdateProgress(message, rate, id);
            }
            else if (type == "HISTORY") {
                ShowHistoryDialog(message, args);
            }
            else if (type == "SCHEDULING") {
                ShowMessage(message);
            }
        };

        // 接続完了時の処理
        $.connection.hub.start().done(function () {
            SendMessageToServer("", "", [""]);
        });

        dialog = $("#history-form").dialog({
            autoOpen: false,
            title: "History",
            height: 400,
            width: 650,
            modal: true,
            buttons: {
                "Close": function () {
                    dialog.dialog("close");
                }
            },
            close: function () {
                $("#historyHeader").empty();
                $("#historyData").empty();
            }
        });

        // スケジュール設定UIの初期表示
        ScheduleSettingUISwitch($("#schedule-select").val());
    };

    // サーバーへのメッセージ送信
    function SendMessageToServer(type, msg, args) {
        comNotifier.server.getMessage(type, msg, args);
    }

    // メッセージ表示
    function ShowMessage(message) {
        alert(message);
    }

    // ******* スケジューリング *******
    // スケジューリングの種別設定変更
    function ScheduleTypeChanged(args) {
        ScheduleSettingUISwitch(args.selectedOptions[0].value);
    }
    // スケジュール設定UIの表示・非表示
    function ScheduleSettingUISwitch(type) {
        if (type == "oneTime") {
            $("#schedule-oneTime").css("display", "block");
            $("#schedule-daily").css("display", "none");
            $("#schedule-day").css("display", "none");
            $("#schedule-detail").css("display", "none");
        }
        else if (type == "date") {
            $("#schedule-oneTime").css("display", "none");
            $("#schedule-daily").css("display", "block");
            $("#schedule-day").css("display", "none");
            $("#schedule-detail").css("display", "none");
        }
        else if (type == "day") {
            $("#schedule-oneTime").css("display", "none");
            $("#schedule-daily").css("display", "none");
            $("#schedule-day").css("display", "block");
            $("#schedule-detail").css("display", "none");
        }
        else if (type == "detail") {
            $("#schedule-oneTime").css("display", "none");
            $("#schedule-daily").css("display", "none");
            $("#schedule-day").css("display", "none");
            $("#schedule-detail").css("display", "block");
        }
    }
    // スケジュール設定の保存
    function SaveScheduling() {
        var type = $("#schedule-select").val();
        var schOneTime = $("#schedule-oneTime-input").val();
        var schDailyInterval = $("#schedule-daily-interval").val();
        var schDailyTime = $("#schedule-daily-time").val();
        var schMon = $('[name=schedule-day-mon]').prop("checked");
        var schTue = $('[name=schedule-day-tue]').prop("checked");
        var schWed = $('[name=schedule-day-wed]').prop("checked");
        var schThr = $('[name=schedule-day-thr]').prop("checked");
        var schFri = $('[name=schedule-day-fri]').prop("checked");
        var schSat = $('[name=schedule-day-sat]').prop("checked");
        var schSun = $('[name=schedule-day-sun]').prop("checked");
        var schDayTime = $("#schedule-day-time").val();
        var schCron = $("#schedule-cron").val();

        var schArgs = [type, schOneTime, schDailyInterval, schDailyTime, schMon, schTue, schWed, schThr, schFri, schSat, schSun, schDayTime, schCron];

        SendMessageToServer("SCHEDULING", "SaveScheduling", schArgs);
    }
    // ******* スケジューリング *******

    // ******* 履歴 *******
    // 履歴データの取得
    function GetHistoryData(historyKind) {
        SendMessageToServer("HISTORY", "GetHistoryData", [historyKind]);
    }
    // 取得した履歴データの表示
    function ShowHistoryDialog(historyKind, historyData) {
        var title = "クロール履歴";
        if (historyKind == "word2vec") {
            title = "機械学習履歴"
        }
        $('#history-form').dialog('option', 'title', title);

        var headerTag = GenerateHeader(historyKind);
        $('#historyHeader').append(headerTag);

        var recordTag = "";

        for (var i = 0; i < historyData.length; i++) {
            var dataArray = historyData[i].split(",");
            recordTag += "<tr>"
            for (var j = 0; j < dataArray.length; j++) {
                recordTag += "<td>" + dataArray[j] + "</td>";
            }
            recordTag += "</tr>"

            $('#historyData').append(recordTag);
            recordTag = ""
        }

        dialog.dialog("open");
    }
    // 履歴ヘッダタグ生成
    function GenerateHeader(historyKind) {
        var header;
        if (historyKind == "Crawl") {
            header = "<tr><th>日時</th><th>クロールファイル数</th><th>Insertファイル数</th><th>キャンセル</th></tr>";
        }
        else if (historyKind == "word2vec") {
            header = "<tr><th>日時</th><th>キャンセル</th></tr>";
        }
        return header;
    }
    // ******* 履歴 *******

    // ******* クロールと機械学習 *******
    // プログレスバーの更新
    function UpdateProgress(message, count, id) {
        // クロール・機械学習実行の途中で設定画面を表示したときでも
        // 画面を非活性状態にするために、常にこれを実行しておく。
        DisableControls(true, id);

        if (count < 0 || count > 100) {
            var dispRate = 100;
            if (count < 0) {
                dispRate = 0;
            }

            $(id).find(".progress-bar").css({ 'width': dispRate + '%' });
            $(id).find(".progress-rate").html(message);

            // 処理が完了したら、プログレスバーの表示をアニメーション → 固定表示に切り替える
            // 100ではなく、101が処理終了を表すコード。
            if (count == 101) {
                $(id).find("#progressType").removeClass("progress-striped active");

                var result = JdugeStartMachineLearning(id);
                if (!result)
                    DisableControls(false);
            }

            return;
        }

        // プログレスバーの表示をストライプ＆アニメーションに変更する。
        if (!$(id).find("#progressType").hasClass("progress-striped active")) {
            $(id).find("#progressType").addClass("progress-striped active");
        }

        $(id).find(".progress-bar").css({ 'width': count + '%' });
        $(id).find(".progress-rate").html(count + '%');
    }

    // 機械学習をスタートさせるかどうかの判断
    function JdugeStartMachineLearning(id) {
        if (id != "#crawlProgressBar")
            return false;

        var machineLearning = $("#execMachineLearningOption").val();

        // スタートさせる選択をしていても、ここから実行することはしない。サーバー側から実行する。
        // UIの活性・非活性の変更とプログレスバーへの処理準備中表示をするのみ。
        if (machineLearning == 1) {
            DisableControls(true, "#machineLearningProgressBar");
            UpdateProgress("処理開始の準備中です。", -3, "#machineLearningProgressBar");
            return true;
        }

        return false;
    }

    // クロール開始
    function StartCrawl() {
        DisableControls(true, "#crawlProgressBar");

        UpdateProgress("処理開始の準備中です。", -3, "#crawlProgressBar")

        // クロール後に機械学習を実行するかどうか。
        var machineLearning = $("#execMachineLearningOption").val();
        // サーバーへ渡すパラメータの生成
        var args = ["#crawlProgressBar", "#machineLearningProgressBar", machineLearning];

        SendMessageToServer("PROGRESS_BAR", "StartCrawl", args);
    }

    // クロールキャンセル
    function CancelCrawl() {
        DisableControls(false);

        SendMessageToServer("PROGRESS_BAR", "CancelCrawl", [""]);
    }

    // 機械学習開始
    function StartMachineLearning() {
        DisableControls(true, "#machineLearningProgressBar");

        UpdateProgress("処理開始の準備中です。", -3, "#machineLearningProgressBar");

        var args = ["#machineLearningProgressBar"];

        SendMessageToServer("PROGRESS_BAR", "StartMachineLearning", args);
    }

    // 機械学習キャンセル
    function CancelMachineLearning() {
        DisableControls(false);

        SendMessageToServer("PROGRESS_BAR", "CancelMachineLearning", [""]);
    }

    // UIの活性・非活性制御
    function DisableControls(enabled, id) {
        // UIコントロール（キャンセルボタン以外）
        $("#crawlFoldersTextBox").prop('disabled', enabled);
        $("#folderApplyButton").prop('disabled', enabled);
        $("#execMachineLearningOption").prop('disabled', enabled);
        $("#crawlStartButton").prop('disabled', enabled);
        $("#machineLearningStartButton").prop('disabled', enabled);

        // キャンセルボタン
        if (id == "#crawlProgressBar") {
            $("#crawlCancelButton").prop('disabled', !enabled);
            $("#machineLearningCancelButton").prop('disabled', enabled);
        }
        else if (id == "#machineLearningProgressBar") {
            $("#crawlCancelButton").prop('disabled', enabled);
            $("#machineLearningCancelButton").prop('disabled', !enabled);
        }
        else {
            $("#crawlCancelButton").prop('disabled', !enabled);
            $("#machineLearningCancelButton").prop('disabled', !enabled);
        }
    }
    // ******* クロールと機械学習 *******

</script>